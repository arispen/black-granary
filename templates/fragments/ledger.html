{{ define "ledger_inner" }}
<h3>Ledger</h3>
{{ if .Traveling }}
  <div class="muted" style="margin-bottom:6px;">Travel in progress: financial actions are paused.</div>
{{ end }}
{{ if .HasOtherPlayers }}
  <form class="actions" hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML" style="margin-top:0;">
    <input type="hidden" name="action" value="loan_offer">
    <select name="target_id" aria-label="Borrower" {{ if $.Traveling }}disabled{{ end }}>
      {{ range .PlayerOptions }}<option value="{{ .ID }}">{{ .Name }}</option>{{ end }}
    </select>
    <input type="number" name="amount" min="1" value="5" style="width:80px;" {{ if $.Traveling }}disabled{{ end }}>
    <button type="submit" {{ if $.Traveling }}disabled{{ end }}>Offer Loan</button>
  </form>
{{ else }}
  <div class="muted" style="margin-bottom:8px;">No other players online for lending.</div>
{{ end }}
<div class="muted" style="margin-top:8px;">Loans</div>
<div class="events" style="max-height:150px;">
  {{ range .Loans }}
    <div class="event-line">
      <div class="event-meta">{{ .ID }} · {{ .LenderName }} -> {{ .BorrowerName }} · due {{ .DueIn }} · {{ .Status }}</div>
      <div>Remaining: {{ .Remaining }}g</div>
      <div class="actions">
        {{ if eq .Status "Offered" }}
          <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML"><input type="hidden" name="action" value="loan_accept"><input type="hidden" name="loan_id" value="{{ .ID }}"><button class="secondary" type="submit" {{ if $.Traveling }}disabled{{ end }}>Accept</button></form>
        {{ end }}
        {{ if eq .Status "Active" }}
          <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML"><input type="hidden" name="action" value="repay"><input type="hidden" name="loan_id" value="{{ .ID }}"><button class="secondary" type="submit" {{ if $.Traveling }}disabled{{ end }}>Repay</button></form>
          <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML"><input type="hidden" name="action" value="default"><input type="hidden" name="loan_id" value="{{ .ID }}"><button class="warn" type="submit" {{ if $.Traveling }}disabled{{ end }}>Default</button></form>
        {{ end }}
      </div>
    </div>
  {{ else }}<div class="muted">No loans.</div>{{ end }}
</div>
<div class="muted" style="margin-top:8px;">Obligations</div>
<div class="events" style="max-height:120px;">
  {{ range .Obligations }}
    <div class="event-line">
      <div class="event-meta">{{ .CreditorName }} <- {{ .DebtorName }} · {{ .Reason }} · sev {{ .Severity }} · cost {{ .Cost }}g · due {{ .DueIn }} · {{ .Status }}</div>
      <div class="actions">
        {{ if .CanSettle }}
          <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML">
            <input type="hidden" name="action" value="settle_obligation">
            <input type="hidden" name="obligation_id" value="{{ .ID }}">
            <button class="secondary" type="submit" {{ if or .SettleDisabled $.Traveling }}disabled{{ end }}>{{ .SettleLabel }}</button>
          </form>
        {{ end }}
        {{ if .CanForgive }}
          <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML">
            <input type="hidden" name="action" value="forgive_obligation">
            <input type="hidden" name="obligation_id" value="{{ .ID }}">
            <button class="secondary" type="submit" {{ if $.Traveling }}disabled{{ end }}>Forgive</button>
          </form>
        {{ end }}
      </div>
    </div>
  {{ else }}<div class="muted">No obligations.</div>{{ end }}
</div>
{{ end }}

{{ define "ledger_oob" }}
<div id="ledger" hx-swap-oob="innerHTML" class="card">
  {{ template "ledger_inner" . }}
</div>
{{ end }}
