{{ define "dashboard" }}
<div class="card">
  <h2>Today's Situation</h2>
  <div class="situation">{{ .Situation }}</div>
  <div class="status-grid">
    <div class="card"><strong>Grain</strong><br>{{ .World.GrainTier }}</div>
    <div class="card"><strong>Unrest</strong><br>{{ .World.UnrestTier }}</div>
    <div class="card"><strong>You</strong><br>{{ .Player.Gold }}g · {{ .PlayerTitle }}</div>
  </div>
</div>
<div class="card" style="margin-top:12px;">
  <h3>Crisis Watch</h3>
  {{ if .Crisis }}
    <div><strong>{{ .Crisis.Name }}</strong> <span class="pill">Severity {{ .Crisis.Severity }}</span></div>
    <div class="muted" style="margin-top:6px;">{{ .Crisis.Description }}</div>
    <div class="muted" style="margin-top:6px;">Ticks left: {{ .Crisis.TicksLeft }} · {{ .Crisis.ResponseCost }}</div>
    {{ if .Crisis.ResponseDisabledReason }}
      <div class="muted" style="margin-top:6px;">{{ .Crisis.ResponseDisabledReason }}</div>
    {{ end }}
    <div class="actions">
      <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML">
        <input type="hidden" name="action" value="respond_crisis">
        <button class="secondary" type="submit" {{ if .Crisis.ResponseDisabled }}disabled{{ end }}>{{ .Crisis.ResponseLabel }}</button>
      </form>
    </div>
  {{ else }}
    <div class="muted">No citywide crises reported.</div>
  {{ end }}
</div>
<div class="card" style="margin-top:12px;">
  <h3>Your Standing in Black Granary</h3>
  <div class="status-grid">
    <div class="card"><strong>Reputation</strong><br>{{ .Standing.ReputationValue }} · {{ .Standing.ReputationLabel }}</div>
    <div class="card"><strong>Heat</strong><br>{{ .Standing.HeatValue }} · {{ .Standing.HeatLabel }}</div>
    <div class="card"><strong>Wealth</strong><br>{{ .Standing.WealthGold }}g</div>
    <div class="card"><strong>Stockpile</strong><br>{{ .Standing.GrainStockpile }} sacks</div>
    <div class="card"><strong>Impact Today</strong><br>{{ .Standing.CompletedToday }}</div>
    <div class="card"><strong>Impact Total</strong><br>{{ .Standing.CompletedTotal }}</div>
    <div class="card"><strong>Rumors</strong><br>{{ .Standing.Rumors }}</div>
    <div class="card"><strong>Permit</strong><br>{{ .Standing.PermitStatus }}</div>
    <div class="card"><strong>Access</strong><br>{{ .Standing.AccessStatus }}</div>
    <div class="card"><strong>Warrant</strong><br>{{ .Standing.WarrantStatus }}</div>
    <div class="card"><strong>High Impact</strong><br>{{ .HighImpactRemaining }} / {{ .HighImpactCap }}</div>
  </div>
</div>
<div class="card" style="margin-top:12px;">
  <h3>Travel & Fieldwork</h3>
  <div><strong>Location</strong><br>{{ .LocationName }}</div>
  <div class="muted" style="margin-top:6px;">{{ .LocationDescription }}</div>
  {{ if .Traveling }}
    <div class="muted" style="margin-top:6px;">En route to {{ .TravelDestination }} · {{ .TravelTicksLeft }} / {{ .TravelTotalTicks }} ticks left</div>
    <div class="muted" style="margin-top:4px;">While traveling, other actions are paused.</div>
  {{ else }}
    {{ if gt (len .LocationOptions) 0 }}
      <form class="actions" hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML" style="margin-top:6px;">
        <input type="hidden" name="action" value="travel">
        <select name="location_id" aria-label="Destination">
          {{ range .LocationOptions }}<option value="{{ .ID }}">{{ .Name }} ({{ .TravelTicks }}t)</option>{{ end }}
        </select>
        <button class="secondary" type="submit">Travel</button>
      </form>
    {{ else }}
      <div class="muted" style="margin-top:6px;">No destinations available.</div>
    {{ end }}
  {{ end }}
  <div class="muted" style="margin-top:8px;">Fieldwork</div>
  {{ if .FieldworkAvailable }}
    <div class="muted" style="margin-top:4px;">{{ .FieldworkDescription }}</div>
    {{ if .FieldworkDisabledReason }}
      <div class="muted" style="margin-top:4px;">{{ .FieldworkDisabledReason }}</div>
    {{ end }}
    <form class="actions" hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML">
      <input type="hidden" name="action" value="{{ .FieldworkAction }}">
      <button class="secondary" type="submit" {{ if .FieldworkDisabled }}disabled{{ end }}>{{ .FieldworkLabel }} ({{ .FieldworkSupplyCost }}g)</button>
    </form>
  {{ else }}
    <div class="muted" style="margin-top:4px;">No fieldwork available at this location.</div>
  {{ end }}
</div>
<div class="card" style="margin-top:12px;">
  <h3>Relics</h3>
  <div class="muted">Appraise relics in the Capital for {{ .RelicAppraiseCost }}g.</div>
  <div class="contracts" style="margin-top:8px;">
    {{ range .Relics }}
      <div class="contract">
        <div><strong>{{ .Name }}</strong> <span class="pill">{{ .Status }}</span></div>
        <div class="meta">
          <span>{{ .EffectLabel }}</span>
        </div>
        {{ if .AppraiseDisabledReason }}
          <div class="contract-outcome">{{ .AppraiseDisabledReason }}</div>
        {{ end }}
        {{ if .InvokeDisabledReason }}
          <div class="contract-outcome">{{ .InvokeDisabledReason }}</div>
        {{ end }}
        <div class="actions">
          {{ if .CanAppraise }}
            <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML" hx-disabled-elt="button">
              <input type="hidden" name="action" value="appraise_relic">
              <input type="hidden" name="relic_id" value="{{ .ID }}">
              <button class="secondary" type="submit" {{ if .AppraiseDisabled }}disabled{{ end }}>Appraise</button>
            </form>
          {{ end }}
          {{ if .CanInvoke }}
            <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML" hx-disabled-elt="button">
              <input type="hidden" name="action" value="invoke_relic">
              <input type="hidden" name="relic_id" value="{{ .ID }}">
              <button type="submit" {{ if .InvokeDisabled }}disabled{{ end }}>Invoke</button>
            </form>
          {{ end }}
        </div>
      </div>
    {{ else }}
      <div class="muted">No relics in your possession.</div>
    {{ end }}
  </div>
</div>
<div class="card" style="margin-top:12px;">
  <h3>Institutions and Offices</h3>
  <div class="muted">Tax: {{ .Policies.TaxRatePct }}% · Permit: {{ if .Policies.PermitRequiredHighRisk }}Required{{ else }}Open{{ end }} · Embargo: {{ .Policies.SmugglingEmbargoTicks }} ticks</div>
  <div class="contracts" style="margin-top:8px;">
    {{ range .Seats }}
      <div class="contract">
        <div><strong>{{ .Name }}</strong> <span class="pill">{{ .InstitutionName }}</span></div>
        <div class="meta">
          <span>Holder: {{ .HolderName }}</span>
          {{ if .IsElectionOpen }}
            <span>Election open: {{ .ElectionWindowTicks }} ticks left</span>
          {{ else }}
            <span>Tenure: {{ .TenureTicksLeft }} ticks left</span>
          {{ end }}
        </div>
        <div class="actions">
          {{ if .CanCampaign }}
            <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML" hx-disabled-elt="button">
              <input type="hidden" name="action" value="campaign_seat">
              <input type="hidden" name="contract_id" value="{{ .ID }}">
              <button type="submit" {{ if $.Traveling }}disabled{{ end }}>Campaign</button>
            </form>
          {{ end }}
          {{ if .CanChallenge }}
            <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML" hx-disabled-elt="button">
              <input type="hidden" name="action" value="challenge_seat">
              <input type="hidden" name="contract_id" value="{{ .ID }}">
              <button class="secondary" type="submit" {{ if $.Traveling }}disabled{{ end }}>Challenge</button>
            </form>
          {{ end }}
          {{ if .CanToggleTaxHigh }}
            <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML" hx-disabled-elt="button">
              <input type="hidden" name="action" value="set_tax_high">
              <button class="secondary" type="submit" {{ if $.Traveling }}disabled{{ end }}>Tax 20%</button>
            </form>
          {{ end }}
          {{ if .CanToggleTaxLow }}
            <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML" hx-disabled-elt="button">
              <input type="hidden" name="action" value="set_tax_low">
              <button class="secondary" type="submit" {{ if $.Traveling }}disabled{{ end }}>Tax 5%</button>
            </form>
          {{ end }}
          {{ if .CanTogglePermit }}
            <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML" hx-disabled-elt="button">
              <input type="hidden" name="action" value="toggle_permit">
              <button class="secondary" type="submit" {{ if $.Traveling }}disabled{{ end }}>{{ if $.Policies.PermitRequiredHighRisk }}Open Permits{{ else }}Require Permits{{ end }}</button>
            </form>
          {{ end }}
          {{ if .CanToggleEmbargo }}
            <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML" hx-disabled-elt="button">
              <input type="hidden" name="action" value="toggle_embargo">
              <button class="secondary" type="submit" {{ if $.Traveling }}disabled{{ end }}>{{ if gt $.Policies.SmugglingEmbargoTicks 0 }}Lift Embargo{{ else }}Impose Embargo{{ end }}</button>
            </form>
          {{ end }}
          {{ if .CanIssuePermit }}
            <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML" hx-disabled-elt="button,select">
              <input type="hidden" name="action" value="issue_permit">
              <select name="target_id" aria-label="Permit recipient" {{ if $.Traveling }}disabled{{ end }}>
                {{ range $.PlayerOptions }}<option value="{{ .ID }}">{{ .Name }}</option>{{ end }}
              </select>
              <button class="secondary" type="submit" {{ if $.Traveling }}disabled{{ end }}>Issue Permit ({{ $.HighImpactRemaining }}/{{ $.HighImpactCap }})</button>
            </form>
          {{ end }}
          {{ if .CanConductInquest }}
            <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML" hx-disabled-elt="button,select">
              <input type="hidden" name="action" value="conduct_inquest">
              <select name="target_id" aria-label="Inquest target" {{ if $.Traveling }}disabled{{ end }}>
                {{ range $.PlayerOptions }}<option value="{{ .ID }}">{{ .Name }}</option>{{ end }}
              </select>
              <button class="secondary" type="submit" {{ if $.Traveling }}disabled{{ end }}>Conduct Inquest ({{ $.HighImpactRemaining }}/{{ $.HighImpactCap }})</button>
            </form>
          {{ end }}
        </div>
      </div>
    {{ end }}
  </div>
  <div class="muted" style="margin-top:10px;">Active Permits</div>
  <div class="contracts" style="margin-top:8px;">
    {{ range .Permits }}
      <div class="contract">
        <div><strong>{{ .PlayerName }}</strong> <span class="pill">Permit</span></div>
        <div class="meta">
          <span>Issued by: {{ .IssuerName }}</span>
          <span>Ticks left: {{ .TicksLeft }}</span>
        </div>
      </div>
    {{ else }}
      <div class="muted">No active permits.</div>
    {{ end }}
  </div>
</div>
<div class="card" style="margin-top:12px;">
  <h3>Contracts</h3>
  <div class="muted">Accepted by you: {{ .AcceptedCount }} · Showing: {{ .VisibleContractN }} / {{ .TotalContractN }}</div>
  {{ if .Traveling }}
    <div class="muted" style="margin-top:4px;">Travel in progress: contract actions are paused.</div>
  {{ end }}
  <div class="contracts" style="margin-top:8px;">
    {{ range .Contracts }}
      <div class="contract {{ .UrgencyClass }}">
        <div><strong>{{ .Type }}</strong> <span class="pill">{{ .Status }}</span></div>
        <div class="meta">
          <span>Deadline: {{ .DeadlineTicks }} ticks</span>
          <span>Taken by: {{ .OwnerName }}</span>
          {{ if .IssuerName }}<span>Posted by: {{ .IssuerName }}</span>{{ end }}
          {{ if .TargetName }}<span>Target: {{ .TargetName }}</span>{{ end }}
          {{ if and (ne .OwnerName "-") (ne .Stance "") }}<span>Stance: {{ .Stance }}</span>{{ end }}
        </div>
        {{ if .ShowOutcome }}
          <div class="contract-outcome">Outcome: {{ .OutcomeLabel }}{{ if .OutcomeNote }} · {{ .OutcomeNote }}{{ end }}</div>
        {{ end }}
        {{ if .RequirementNote }}
          <div class="contract-outcome">{{ .RequirementNote }}</div>
        {{ end }}
        {{ if .RewardNote }}
          <div class="contract-outcome">{{ .RewardNote }}</div>
        {{ end }}
        <div class="actions">
          {{ if .CanAccept }}
            <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML" hx-disabled-elt="button,select">
              <input type="hidden" name="action" value="accept">
              <input type="hidden" name="contract_id" value="{{ .ID }}">
              {{ if and (not .IsBounty) (not .IsSupply) }}
                <select name="stance" aria-label="Choose stance" {{ if $.Traveling }}disabled{{ end }}>
                  <option value="Careful" selected>Careful</option>
                  <option value="Fast">Fast</option>
                  <option value="Quiet">Quiet</option>
                </select>
              {{ end }}
              <button type="submit" {{ if $.Traveling }}disabled{{ end }}>Accept</button>
            </form>
          {{ end }}
          {{ if .CanIgnore }}
            <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML" hx-disabled-elt="button">
              <input type="hidden" name="action" value="ignore">
              <input type="hidden" name="contract_id" value="{{ .ID }}">
              <button class="secondary" type="submit" {{ if $.Traveling }}disabled{{ end }}>Ignore</button>
            </form>
          {{ end }}
          {{ if .CanAbandon }}
            <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML" hx-disabled-elt="button">
              <input type="hidden" name="action" value="abandon">
              <input type="hidden" name="contract_id" value="{{ .ID }}">
              <button class="secondary" type="submit" {{ if $.Traveling }}disabled{{ end }}>Abandon</button>
            </form>
          {{ end }}
          {{ if .CanCancel }}
            <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML" hx-disabled-elt="button">
              <input type="hidden" name="action" value="cancel_contract">
              <input type="hidden" name="contract_id" value="{{ .ID }}">
              <button class="secondary" type="submit" {{ if $.Traveling }}disabled{{ end }}>Withdraw</button>
            </form>
          {{ end }}
          {{ if .CanDeliver }}
            <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML" hx-disabled-elt="button">
              <input type="hidden" name="action" value="deliver">
              <input type="hidden" name="contract_id" value="{{ .ID }}">
              <button class="warn" type="submit" {{ if or .DeliverDisabled $.Traveling }}disabled{{ end }}>{{ .DeliverLabel }}</button>
            </form>
          {{ end }}
        </div>
      </div>
    {{ else }}
      <div class="muted">No contracts on the board.</div>
    {{ end }}
  </div>
  <div class="actions" style="margin-top:10px;">
    <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML">
      <input type="hidden" name="action" value="investigate">
      <button type="submit" {{ if or .InvestigateDisabled $.Traveling }}disabled{{ end }}>{{ .InvestigateLabel }}</button>
    </form>
    <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML">
      <input type="hidden" name="action" value="post_supply">
      <input type="number" name="sacks" min="2" max="10" value="4" style="width:70px;" {{ if $.Traveling }}disabled{{ end }}>
      <input type="number" name="reward" min="6" max="60" value="12" style="width:70px;" {{ if $.Traveling }}disabled{{ end }}>
      <button class="secondary" type="submit" {{ if $.Traveling }}disabled{{ end }}>Post Supply</button>
    </form>
    <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML">
      <input type="hidden" name="action" value="petition_institution">
      <button class="secondary" type="submit" {{ if $.Traveling }}disabled{{ end }}>Petition</button>
    </form>
    <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML">
      <input type="hidden" name="action" value="bribe_official">
      <input type="hidden" name="amount" value="3">
      <button class="secondary" type="submit" {{ if $.Traveling }}disabled{{ end }}>Bribe</button>
    </form>
    <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML">
      <input type="hidden" name="action" value="broker_deal">
      <button class="secondary" type="submit" {{ if $.Traveling }}disabled{{ end }}>Broker Deal</button>
    </form>
    <form hx-post="/action" hx-target="#dashboard" hx-swap="innerHTML">
      <input type="hidden" name="action" value="invoke_rite">
      <button class="secondary" type="submit" {{ if $.Traveling }}disabled{{ end }}>Invoke Rite</button>
    </form>
  </div>
</div>
{{ end }}
